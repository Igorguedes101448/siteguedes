<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupos - ChefGuedes</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="../index.html">ChefGuedes</a>
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="explorar-receitas.html">Explorar Receitas</a></li>
                <li id="authMenuItems"></li>
            </ul>
            <div id="notificationDropdown" class="notification-dropdown" style="display: none;">
                <button class="notification-btn" onclick="toggleNotifications()">
                    üîî
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                </button>
                <div id="notificationMenu" class="notification-menu">
                    <div class="notification-header">
                        <h4>Notifica√ß√µes</h4>
                        <button onclick="markAllRead()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" class="notification-list">
                        <p style="text-align: center; color: var(--text-secondary); padding: 20px;">Sem notifica√ß√µes</p>
                    </div>
                </div>
            </div>
            <div id="profileDropdown" class="profile-dropdown" style="display: none;">
                <button class="profile-btn" onclick="toggleProfileMenu()">
                    <img id="profileImage" src="" alt="Perfil" class="profile-image">
                    <span id="profileName"></span>
                </button>
                <div id="profileMenu" class="profile-menu">
                    <a href="perfil.html">Meu Perfil</a>
                    <a href="dashboard.html">Dashboard</a>
                    <a href="#" onclick="logout(); return false;">Sair</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="page-header">
            <h1>Meus Grupos</h1>
            <p>Organize grupos e planeie refei√ß√µes em conjunto</p>
        </div>

        <button class="btn btn-primary mb-3" onclick="openModal('modalNovoGrupo')">+ Criar Novo Grupo</button>

        <div id="groupsList"></div>

        <!-- Tabs para grupo selecionado -->
        <div id="groupDetails" style="display: none;">
            <div class="dashboard-card" style="margin-top: 30px;">
                <h3 id="groupName"></h3>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('membros')">Membros</button>
                    <button class="tab" onclick="switchTab('agendamento')">Agendamento Semanal</button>
                </div>

                <div id="tabMembros" class="tab-content active"></div>
                <div id="tabAgendamento" class="tab-content"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 ChefGuedes. Todos os direitos reservados.</p>
    </footer>

    <!-- Modal Novo Grupo -->
    <div id="modalNovoGrupo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Criar Novo Grupo</h3>
                <button class="modal-close" onclick="closeModal('modalNovoGrupo')">&times;</button>
            </div>
            <form onsubmit="submitGroup(event)">
                <div class="form-group">
                    <label for="groupName">Nome do Grupo:</label>
                    <input type="text" id="groupNameInput" required>
                </div>
                <div class="form-group">
                    <label for="groupDescription">Descri√ß√£o:</label>
                    <textarea id="groupDescription" rows="3" placeholder="Descri√ß√£o opcional do grupo..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('modalNovoGrupo')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Grupo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar Refei√ß√£o -->
    <div id="modalAddMeal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Refei√ß√£o</h3>
                <button class="modal-close" onclick="closeModal('modalAddMeal')">&times;</button>
            </div>
            <form onsubmit="submitMeal(event)">
                <input type="hidden" id="mealDate">
                <div class="form-group">
                    <label>Tipo de Refei√ß√£o:</label>
                    <select id="mealType" required>
                        <option value="Pequeno-almo√ßo">Pequeno-almo√ßo</option>
                        <option value="Almo√ßo">Almo√ßo</option>
                        <option value="Jantar">Jantar</option>
                        <option value="Lanche">Lanche</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Receita:</label>
                    <select id="mealRecipe" required></select>
                </div>
                <div class="form-group">
                    <label>Notas (opcional):</label>
                    <textarea id="mealNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('modalAddMeal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar Membro -->
    <div id="modalAddMember" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Adicionar Membro ao Grupo</h3>
                <button class="modal-close" onclick="closeModal('modalAddMember')">&times;</button>
            </div>
            <form onsubmit="submitAddMember(event)">
                <div class="form-group">
                    <label for="memberCode">C√≥digo do Utilizador:</label>
                    <input 
                        type="text" 
                        id="memberCode" 
                        required 
                        placeholder="Ex: ABC123"
                        maxlength="6"
                        style="text-transform: uppercase; font-family: 'Courier New', monospace; font-size: 1.2rem; letter-spacing: 2px;"
                        oninput="this.value = this.value.toUpperCase()">
                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                        Insira o c√≥digo de 6 caracteres do utilizador que deseja adicionar
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('modalAddMember')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Membro</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/auth-api.js"></script>
    <script src="../js/main-api.js"></script>
    <script src="../js/profanity-filter.js"></script>
    <script src="../js/clear-recipes.js"></script>
    <script>
        // Proteger rota
        (async function() {
            await requireAuth();
            loadGroups();
        })();

        // Ativar valida√ß√£o em tempo real para campos de grupo
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                validateFieldRealtime('groupNameInput', 'O nome do grupo');
                validateFieldRealtime('groupDescription', 'A descri√ß√£o');
            }, 500);
        });

        let currentGroupId = null;
        let currentWeekStart = getWeekStart(new Date());

        async function loadGroups() {
            const groups = await getAllGroups();
            const currentUser = await getCurrentUser();
            
            // Filtrar grupos criados pelo utilizador atual
            const userGroups = groups.filter(g => g.created_by === currentUser?.id);
            
            const container = document.getElementById('groupsList');
            
            if (userGroups.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Ainda n√£o criou nenhum grupo. Clique em "Criar Novo Grupo" para come√ßar.</p>';
                return;
            }
            
            container.innerHTML = userGroups.map(group => `
                <div class="dashboard-card" style="cursor: pointer;" onclick="selectGroup('${group.id}')">
                    <h3>${group.name}</h3>
                    <p style="color: var(--text-secondary);">${group.description || 'Sem descri√ß√£o'}</p>
                    <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 10px;">${group.member_count || 0} membros</p>
                </div>
            `).join('');
        }

        async function submitGroup(e) {
            e.preventDefault();
            
            const groupData = {
                name: document.getElementById('groupNameInput').value,
                description: document.getElementById('groupDescription').value
            };
            
            // Validar nome do grupo
            const nameCheck = checkProfanity(groupData.name);
            if (!nameCheck.isClean) {
                showError('O nome do grupo cont√©m palavras inadequadas.');
                showFieldValidation('groupNameInput', false, 'O nome cont√©m palavras inadequadas.');
                return;
            }
            
            // Validar descri√ß√£o do grupo
            if (groupData.description) {
                const descCheck = checkProfanity(groupData.description);
                if (!descCheck.isClean) {
                    showError('A descri√ß√£o do grupo cont√©m palavras inadequadas.');
                    showFieldValidation('groupDescription', false, 'A descri√ß√£o cont√©m palavras inadequadas.');
                    return;
                }
            }
            
            const result = await saveGroup(groupData);
            
            if (result.success) {
                closeModal('modalNovoGrupo');
                e.target.reset();
                await loadGroups();
                showSuccess('Grupo criado com sucesso!');
            } else {
                showError(result.message || 'Erro ao criar grupo.');
            }
        }

        async function selectGroup(groupId) {
            currentGroupId = groupId;
            const group = await getGroupById(groupId);
            
            if (!group) {
                showError('Grupo n√£o encontrado.');
                return;
            }
            
            document.getElementById('groupDetails').style.display = 'block';
            document.getElementById('groupName').textContent = group.name;
            
            switchTab('membros');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tabName === 'membros') {
                document.getElementById('tabMembros').classList.add('active');
                loadMembers();
            } else if (tabName === 'agendamento') {
                document.getElementById('tabAgendamento').classList.add('active');
                loadSchedule();
            }
        }

        async function loadMembers() {
            const members = await getGroupMembers(currentGroupId);
            const container = document.getElementById('tabMembros');
            
            if (!members || members.length === 0) {
                container.innerHTML = `
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-secondary);">Nenhum membro no grupo.</p>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="openModal('modalAddMember')">+ Adicionar Membro</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openModal('modalAddMember')">+ Adicionar Membro</button>
                    ${members.map(member => `
                        <div class="activity-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${member.username}</strong>
                                <span style="color: ${member.role === 'admin' ? 'var(--primary-color)' : 'var(--text-secondary)'}; font-size: 0.9rem; margin-left: 10px;">
                                    ${member.role === 'admin' ? 'Admin' : 'Membro'}
                                </span>
                            </div>
                            ${member.role !== 'admin' ? `
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;" onclick="removeMember(${member.user_id})">Remover</button>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function loadSchedule() {
            const container = document.getElementById('tabAgendamento');
            const weekDays = getWeekDays(currentWeekStart);
            const weekEnd = getWeekEnd(currentWeekStart);
            const schedules = getSchedulesByWeek(currentWeekStart, weekEnd).filter(s => s.groupId === currentGroupId);
            
            container.innerHTML = `
                <div class="week-navigation">
                    <button class="btn btn-outline" onclick="changeWeek(-1)">‚Üê Semana Anterior</button>
                    <h3>${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}</h3>
                    <button class="btn btn-outline" onclick="changeWeek(1)">Pr√≥xima Semana ‚Üí</button>
                </div>
                <div class="schedule-grid">
                    ${weekDays.map(day => {
                        const dateStr = getDateForInput(day);
                        const daySchedules = schedules.filter(s => s.date === dateStr);
                        
                        return `
                            <div class="day-card">
                                <h4>${getDayName(day)} - ${day.getDate()}/${day.getMonth() + 1}</h4>
                                ${daySchedules.map(schedule => {
                                    // TODAS AS RECEITAS FORAM REMOVIDAS
                                    return `
                                        <div class="meal-item">
                                            <div>
                                                <div class="meal-type">${schedule.mealType}</div>
                                                <div class="meal-recipe">Receita n√£o dispon√≠vel</div>
                                                ${schedule.notes ? `<div class="meal-notes">${schedule.notes}</div>` : ''}
                                            </div>
                                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;" onclick="removeSchedule('${schedule.id}')">‚úï</button>
                                        </div>
                                    `;
                                }).join('')}
                                <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="openAddMeal('${dateStr}')">+ Adicionar</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function changeWeek(direction) {
            const current = new Date(currentWeekStart);
            current.setDate(current.getDate() + (direction * 7));
            currentWeekStart = getWeekStart(current);
            loadSchedule();
        }

        function openAddMeal(dateStr) {
            document.getElementById('mealDate').value = dateStr;
            
            // TODAS AS RECEITAS FORAM REMOVIDAS - n√£o h√° receitas para selecionar
            const select = document.getElementById('mealRecipe');
            select.innerHTML = '<option value="">Nenhuma receita dispon√≠vel</option>';
            
            // Desabilitar o formul√°rio pois n√£o h√° receitas
            showError('N√£o h√° receitas dispon√≠veis no sistema.');
            return;
        }

        function submitMeal(e) {
            e.preventDefault();
            
            const schedule = {
                groupId: currentGroupId,
                date: document.getElementById('mealDate').value,
                mealType: document.getElementById('mealType').value,
                recipeId: document.getElementById('mealRecipe').value,
                notes: document.getElementById('mealNotes').value
            };
            
            saveSchedule(schedule);
            addActivity('schedule_add', `Agendou uma refei√ß√£o`);
            closeModal('modalAddMeal');
            e.target.reset();
            loadSchedule();
            showSuccess('Refei√ß√£o agendada!');
        }

        function removeSchedule(scheduleId) {
            if (confirm('Remover esta refei√ß√£o do agendamento?')) {
                deleteSchedule(scheduleId);
                loadSchedule();
                showSuccess('Refei√ß√£o removida.');
            }
        }

        async function submitAddMember(e) {
            e.preventDefault();
            
            const userCode = document.getElementById('memberCode').value.trim().toUpperCase();
            
            if (userCode.length !== 6) {
                showError('O c√≥digo deve ter exatamente 6 caracteres.');
                return;
            }
            
            const result = await addGroupMember(currentGroupId, userCode);
            
            if (result.success) {
                closeModal('modalAddMember');
                document.getElementById('memberCode').value = '';
                await loadMembers();
                showSuccess('Membro adicionado com sucesso!');
            } else {
                showError(result.message || 'Erro ao adicionar membro.');
            }
        }

        async function removeMember(userId) {
            if (!confirm('Tem certeza que deseja remover este membro do grupo?')) {
                return;
            }
            
            const result = await removeGroupMember(currentGroupId, userId);
            
            if (result.success) {
                await loadMembers();
                showSuccess('Membro removido com sucesso!');
            } else {
                showError(result.message || 'Erro ao remover membro.');
            }
        }
    </script>
</body>
</html>
